{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <!-- Suchformular -->  
    <div class="col-12 col-md-12">
        <div class="p-3 border bg-light">
            <form id="searchForm">
                <div class="mb-3">
                    <label for="query" class="form-label">Song Title / Interpret</label>
                    <input type="text" class="form-control" id="query" name="query" placeholder="Serch Song or Interpret">
                </div>

                <div class="mb-3">
                    <label for="query" class="form-label">Search</label>
                    <select class="form-select me-2" name="filter" id="filter">
                        <option value="TITLE">Song Title</option>
                        <option value="INTERPRET">Interpret</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="year" class="form-label">Year</label>
                    <input type="number" class="form-control" id="year" name="year" placeholder="Year">
                </div>
                
                <div class="mb-3 btn-center">
                    <button class="btn btn-primary" type="submit">Suchen</button>
                </div>
            </form>
        </div>        
    </div>          

    <!-- Bootstrap Spinner -->
    <div id="loadingSpinner" class="d-flex justify-content-center align-items-center hidden">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <h1 class="text-center">Search Results</h1>        
    <table class="table table-striped table-hover mt-4" id="songTable">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>COVER</th>
                <th>Interpret</th>
                <th>Titel</th>
                <th>USDB Link</th>
                <th>Download</th>
            </tr>
        </thead>
        <tbody>
            <!-- Songs werden dynamisch geladen -->
        </tbody>
    </table>
</div>

<!-- Modal - QueryList -->
<div class="modal fade" id="downloadListModal" tabindex="-1" aria-labelledby="downloadListModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="downloadListModalLabel">Query List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Hier wird die Download-Liste geladen -->
                <ul id="downloadList" class="list-group">
                    <!-- Dynamische Inhalte -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Download All</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>        
<script>

    // AJAX für das Suchformular
    document.getElementById('searchForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Verhindere das Standardformularverhalten

        // Hole die Werte aus dem Formular
        const query = document.getElementById('query').value;
        const filter = document.getElementById('filter').value;

        // Zeige den Spinner
        const spinner = document.getElementById('loadingSpinner');
        // spinner.style.display = 'flex !important;';
        spinner.classList.remove('hidden');

        // Sende AJAX-Request an den Flask-Endpunkt
        fetch(`/search?query=${encodeURIComponent(query)}&filter=${filter}`)
            .then(response => response.json())
            .then(data => {
                // Tabelle aktualisieren
                const tableBody = document.querySelector('#songTable tbody');
                tableBody.innerHTML = ''; // Leere die Tabelle

                if (data.length > 0) {
                    data.forEach(song => {
                        const row = `
                            <tr>
                                <td>${song.SONG_ID}</td>
                                <td>
                                    <img src="${song.SONG_COVER_URL}" alt="Cover" width="100" height="100">
                                </td>
                                <td>${song.SONG_INTERPRET}</td>
                                <td>${song.SONG_TITEL}</td>
                                <td>
                                    <a href="https://usdb.animux.de/?link=detail&id=${song.SONG_ID}" target="_blank">Song Details</a>
                                </td>
                                <td>
                                    <button class="btn btn-success download-button" 
                                    data-id="${song.SONG_ID}"
                                    data-interpret="${song.SONG_INTERPRET}"
                                    data-title="${song.SONG_TITEL}">
                                        Download
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });

                    // Add Songs to Download List
                    document.querySelectorAll('.download-button').forEach(button => {
                        button.addEventListener('click', function () {
                            const songId = this.getAttribute('data-id');
                            const songInterpret = this.getAttribute('data-interpret');
                            const songTitle = this.getAttribute('data-title');
                            addToDownload(songId, songInterpret, songTitle);
                        });
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Keine Songs gefunden.</td></tr>';
                }
            })
            .catch(error => console.error('Fehler bei der Suche:', error))
            .finally(() => {
                // Verstecke den Spinner
                // spinner.style.display = 'none';
                spinner.classList.add('hidden');
            });
    });

    // Send SONG_ID to Flask
    function addToDownload(songId, songInterpret, songTitle) {
        fetch('/add_to_download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                SONG_ID: songId,
                SONG_INTERPRET: songInterpret,
                SONG_TITEL: songTitle,
            }),
        })
            .then(response => response.json())
            .then(data => {
                console.log('Serverantwort:', data);
                alert(data.message);
            })
            .catch(console.error);
    }

    // Funktion zum Entfernen eines Songs aus der Liste
    function removeFromDownloadList(songId) {
        fetch('/remove_from_download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ SONG_ID: songId }),
        })
            .then(response => response.json())
            .then(data => {
                console.log('Serverantwort:', data);
                alert(data.message);

                // Aktualisiere die Liste im Modal
                // document.getElementById('query_button').click();
            })
            .catch(console.error);
    }

    document.getElementById('query_button').addEventListener('click', function () {
        // Lade die Download-Liste von Flask
        fetch('/get_query_list')
            .then(response => response.json())
            .then(data => {
                const downloadList = document.getElementById('downloadList');
                downloadList.innerHTML = ''; // Leere die aktuelle Liste
    
                if (data.length > 0) {
                    console.log(data)
                    data.forEach(song => {
                        const listItem = `
                            <li class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${song.SONG_INTERPRET} - ${song.SONG_TITEL}</h6>                                        
                                </div>
                                <small class="mb-1">USDB-ID: ${song.SONG_ID}</small> 
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped bg-info" role="progressbar" aria-valuenow="15" style="width: 15%" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="action-btn-bar mb-1">
                                    <button class="btn btn-primary btn-sm remove-song-button" data-id="${song.SONG_ID}">
                                        <i class="fa-solid fa-download"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm remove-song-button" data-id="${song.SONG_ID}">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </div>                                    
                            </li>
                        `;
                        downloadList.innerHTML += listItem;
                    });

                    // Event-Listener für alle "X"-Buttons hinzufügen
                    document.querySelectorAll('.remove-song-button').forEach(button => {
                        button.addEventListener('click', function () {
                            const songId = this.getAttribute('data-id');
                            removeFromDownloadList(songId);
                        });
                    });
                } else {
                    downloadList.innerHTML = '<li class="list-group-item text-center">Keine Songs in der Download-Liste</li>';
                }
    
                // Öffne das Modal
                const modal = new bootstrap.Modal(document.getElementById('downloadListModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Fehler beim Laden der Download-Liste:', error);
            });
    });
    
</script>
{% endblock %}